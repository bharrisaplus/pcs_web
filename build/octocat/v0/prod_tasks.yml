# yaml-language-server: $schema=https://taskfile.dev/schema.json

# Tasks are expected to be called from the project root or via the main Taskfile

version: '3'

tasks:
  rear-presentation:
    desc: Stylus to CSS
    cmds:
      - pnpm stylus {{.PRESENTATION_DIR}}/demo.styl -o {{.PAGES_HOST_DIR}}/{{.CSS_MAIN_NAME}}
      - pnpm postcss {{.PAGES_HOST_DIR}}/{{.CSS_MAIN_NAME}} --config {{.PROJECT_DIR}} -o {{.PAGES_HOST_DIR}}/{{.CSS_MAIN_NAME}}
    env:
      NODE_ENV: production
  rear-content:
    desc: Pug to HTML
    cmds:
      - echo {{.CONTENT_DATA}} > {{.PAGES_HOST_DIR}}/content_data_options.json
      - pnpm pug {{.CONTENT_DIR}}/demo.pug -o {{.PAGES_HOST_DIR}} -O {{.PAGES_HOST_DIR}}/content_data_options.json
      - mv {{.PAGES_HOST_DIR}}/demo.html {{.PAGES_HOST_DIR}}/index.html
      #- rm -f {{.PAGES_HOST_DIR}}/content_data_options.json
    vars:
      APPLE_TOUCH_ICON_URL: '{{.PAGES_HOST}}{{.APPLE_TOUCH_ICON_NAME}}'
      FAVICON_32_URL: '{{.PAGES_HOST}}{{.FAVICON_32_NAME}}'
      FAVICON_32_ALT_URL: '{{.PAGES_HOST}}{{.FAVICON_32_ALT_NAME}}'
      FAVICON_16_URL: '{{.PAGES_HOST}}{{.FAVICON_16_NAME}}'
      FAVICON_16_ALT_URL: '{{.PAGES_HOST}}{{.FAVICON_16_ALT_NAME}}'
      FAVICON_ICO_URL: '{{.PAGES_HOST}}{{.FAVICON_ICO_NAME}}'
      FAVICON_ICO_ALT_URL: '{{.PAGES_HOST}}{{.FAVICON_ICO_ALT_NAME}}'
      VENDOR_CSS_RESET_URL: '{{.PAGES_HOST}}{{.VENDOR_CSS_RESET_NAME}}'
      VENDOR_CHANCEJS_URL: '{{.PAGES_HOST}}{{.VENDOR_CHANCEJS_NAME}}'
      VENDOR_HTML2CANVAS_URL: '{{.PAGES_HOST}}{{.VENDOR_HTML2CANVAS_NAME}}'
      CSS_MAIN_URL: '{{.PAGES_HOST}}{{.CSS_MAIN_NAME}}'
      ES_MAIN_URL: '{{.PAGES_HOST}}{{.ES_MAIN_NAME}}'
      BROWSERCONFIG_URL: '{{.PAGES_HOST}}{{.BROWSERCONFIG_NAME}}'
      WEBMANIFEST_URL: '{{.PAGES_HOST}}{{.WEBMANIFEST_NAME}}'
      # Turn above variables into a json string
      CONTENT_DATA: '{\"APPLE_TOUCH_ICON_URL\": \"{{.APPLE_TOUCH_ICON_URL}}\",\"FAVICON_32_URL\": \"{{.FAVICON_32_URL}}\",\"FAVICON_32_ALT_URL\": \"{{.FAVICON_32_ALT_URL}}\",\"FAVICON_16_URL\": \"{{.FAVICON_16_URL}}\",\"FAVICON_16_ALT_URL\": \"{{.FAVICON_16_ALT_URL}}\",\"FAVICON_ICO_URL\": \"{{.FAVICON_ICO_URL}}\",\"FAVICON_ICO_ALT_URL\": \"{{.FAVICON_ICO_ALT_URL}}\",\"VENDOR_CSS_RESET_URL\": \"{{.VENDOR_CSS_RESET_URL}}\",\"VENDOR_CHANCEJS_URL\": \"{{.VENDOR_CHANCEJS_URL}}\",\"VENDOR_HTML2CANVAS_URL\": \"{{.VENDOR_HTML2CANVAS_URL}}\",\"CSS_MAIN_URL\": \"{{.CSS_MAIN_URL}}\",\"ES_MAIN_URL\": \"{{.ES_MAIN_URL}}\",\"BROWSERCONFIG_URL\": \"{{.BROWSERCONFIG_URL}}\",\"WEBMANIFEST_URL\": \"{{.WEBMANIFEST_URL}}\"}'
  rear-behavior:
    desc: JS
    cmds:
      -  pnpm rollup -c {{.PROJECT_DIR}}/rollup.config.mjs
    env:
      NODE_ENV: production
  put-vendor:
    desc: Copy 3rd party scripts/stylesheets/etc
    cmds:
      - cp {{.COMMON_DIR}}/vendor/meyerweb/reset.min.css {{.PAGES_HOST_DIR}}/{{.VENDOR_CSS_RESET_NAME}}
      - cp {{.COMMON_DIR}}/vendor/html2canvas/html2canvas.min.js {{.PAGES_HOST_DIR}}/{{.VENDOR_HTML2CANVAS_NAME}}
      - cp {{.COMMON_DIR}}/vendor/chancejs/chance.min.js {{.PAGES_HOST_DIR}}/{{.VENDOR_CHANCEJS_NAME}}
      - echo "MeyerWeb-CSSReset, HTML2Canvas and ChanceJS placed with pages host files"
  put-meta:
    desc: Place fils needed for pwa
    cmds:
      - cp {{.COMMON_DIR}}/favicons/sqwiggle.ico {{.PAGES_HOST_DIR}}/{{.FAVICON_ICO_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle-alt.ico {{.PAGES_HOST_DIR}}/{{.FAVICON_ICO_ALT_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_16.png {{.PAGES_HOST_DIR}}/{{.FAVICON_16_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_16-alt.png {{.PAGES_HOST_DIR}}/{{.FAVICON_16_ALT_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_32.png {{.PAGES_HOST_DIR}}/{{.FAVICON_32_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_32-alt.png {{.PAGES_HOST_DIR}}/{{.FAVICON_32_ALT_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_180.png {{.PAGES_HOST_DIR}}/{{.APPLE_TOUCH_ICON_NAME}}
      - cp {{.CONTENT_DIR}}/browserconfig.source.xml {{.PAGES_HOST_DIR}}/{{.BROWSERCONFIG_NAME}}
      - cp {{.CONTENT_DIR}}/webmanifest.source.json {{.PAGES_HOST_DIR}}/{{.WEBMANIFEST_NAME}}
      - echo "Favicon and Offline files placed with pages host files"
  sweep-content:
    desc: Clear out pages host directory
    cmds:
      - rm -f {{.PAGES_HOST_DIR}}/index.html
      - rm -f {{.PAGES_HOST_DIR}}/content_data_options.json
  sweep-presentation:
    desc: Clear out pages host directory
    cmds:
      - rm -f {{.PAGES_HOST_DIR}}/main.css
  sweep-behavior:
    desc: Clear out pages host directory
    cmds:
      - rm -f {{.PAGES_HOST_DIR}}/main.{js,mjs}
  sweep-vendor:
    desc: Remove generated files
    cmds:
      - rm -f {{.PAGES_HOST_DIR}}/html2canvas.{js,js.map}
      - rm -f {{.PAGES_HOST_DIR}}/chance.{js,min.js,min.js.map}
      - rm -f {{.PAGES_HOST_DIR}}/reset.css
  sweep-meta:
    desc: Remove generated files
    cmds:
      - rm -f {{.PAGES_HOST_DIR}}/{{.FAVICON_ICO_NAME}}
      - rm -f {{.PAGES_HOST_DIR}}/{{.FAVICON_ICO_ALT_NAME}}
      - rm -f {{.PAGES_HOST_DIR}}/{{.FAVICON_16_NAME}}
      - rm -f {{.PAGES_HOST_DIR}}/{{.FAVICON_16_ALT_NAME}}
      - rm -f {{.PAGES_HOST_DIR}}/{{.FAVICON_32_NAME}}
      - rm -f {{.PAGES_HOST_DIR}}/{{.FAVICON_32_ALT_NAME}}
      - rm -f {{.PAGES_HOST_DIR}}/{{.APPLE_TOUCH_ICON_NAME}}
      - rm -f {{.PAGES_HOST_DIR}}/{{.BROWSERCONFIG_NAME}}
      - rm -f {{.PAGES_HOST_DIR}}/{{.WEBMANIFEST_NAME}}
