# yaml-language-server: $schema=https://taskfile.dev/schema.json

# Tasks are expected to be called from the project root or via the main Taskfile

version: '3'

tasks:
  rear-presentation:
    desc: Stylus to CSS
    cmds:
      - pnpm stylus {{.PRESENTATION_DIR}}/demo.main.styl -o {{.OCTOCAT_HOST_DIR}}/{{.CSS_MAIN_NAME}}
      - pnpm postcss {{.OCTOCAT_HOST_DIR}}/{{.CSS_MAIN_NAME}} --config {{.PROJECT_DIR}} -o {{.OCTOCAT_HOST_DIR}}/{{.CSS_MAIN_NAME}}
    env:
      NODE_ENV: prod
  rear-content:
    desc: Pug to HTML
    cmds:
      - echo {{.CONTENT_DATA}} > {{.OCTOCAT_HOST_DIR}}/content_data_options.json
      - pnpm pug {{.CONTENT_DIR}}/demo.page.pug -o {{.OCTOCAT_HOST_DIR}} -O {{.OCTOCAT_HOST_DIR}}/content_data_options.json
      - mv {{.OCTOCAT_HOST_DIR}}/demo.page.html {{.OCTOCAT_HOST_DIR}}/index.html
      - rm -f {{.OCTOCAT_HOST_DIR}}/content_data_options.json
      - cp {{.CONTENT_DIR}}/graphic/icon/sqwiggle.svg {{.OCTOCAT_HOST_DIR}}/{{.MARKLOGO_NAME}}
    vars:
      MARKLOGO_URL: '{{.OCTOCAT_HOST}}{{.MARKLOGO_NAME}}'
      APPLE_TOUCH_ICON_URL: '{{.OCTOCAT_HOST}}{{.APPLE_TOUCH_ICON_NAME}}'
      FAVICON_32_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_32_NAME}}'
      FAVICON_32_ALT_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_32_ALT_NAME}}'
      FAVICON_16_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_16_NAME}}'
      FAVICON_16_ALT_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_16_ALT_NAME}}'
      FAVICON_ICO_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_ICO_NAME}}'
      FAVICON_ICO_ALT_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_ICO_ALT_NAME}}'
      VENDOR_CSS_RESET_URL: '{{.OCTOCAT_HOST}}{{.VENDOR_CSS_RESET_NAME}}'
      VENDOR_CHANCEJS_URL: '{{.OCTOCAT_HOST}}{{.VENDOR_CHANCEJS_NAME}}'
      VENDOR_HTML2CANVAS_URL: '{{.OCTOCAT_HOST}}{{.VENDOR_HTML2CANVAS_NAME}}'
      CSS_MAIN_URL: '{{.OCTOCAT_HOST}}{{.CSS_MAIN_NAME}}'
      ES_MAIN_URL: '{{.OCTOCAT_HOST}}{{.ES_MAIN_NAME}}'
      BROWSERCONFIG_URL: '{{.OCTOCAT_HOST}}{{.BROWSERCONFIG_NAME}}'
      WEBMANIFEST_URL: '{{.OCTOCAT_HOST}}{{.WEBMANIFEST_NAME}}'
      # Turn above variables into a json string
      CONTENT_DATA: '{\"MARKLOGO_URL\": \"{{.MARKLOGO_URL}}\",\"APPLE_TOUCH_ICON_URL\": \"{{.APPLE_TOUCH_ICON_URL}}\",\"FAVICON_32_URL\": \"{{.FAVICON_32_URL}}\",\"FAVICON_32_ALT_URL\": \"{{.FAVICON_32_ALT_URL}}\",\"FAVICON_16_URL\": \"{{.FAVICON_16_URL}}\",\"FAVICON_16_ALT_URL\": \"{{.FAVICON_16_ALT_URL}}\",\"FAVICON_ICO_URL\": \"{{.FAVICON_ICO_URL}}\",\"FAVICON_ICO_ALT_URL\": \"{{.FAVICON_ICO_ALT_URL}}\",\"VENDOR_CSS_RESET_URL\": \"{{.VENDOR_CSS_RESET_URL}}\",\"VENDOR_CHANCEJS_URL\": \"{{.VENDOR_CHANCEJS_URL}}\",\"VENDOR_HTML2CANVAS_URL\": \"{{.VENDOR_HTML2CANVAS_URL}}\",\"CSS_MAIN_URL\": \"{{.CSS_MAIN_URL}}\",\"ES_MAIN_URL\": \"{{.ES_MAIN_URL}}\",\"BROWSERCONFIG_URL\": \"{{.BROWSERCONFIG_URL}}\",\"WEBMANIFEST_URL\": \"{{.WEBMANIFEST_URL}}\"}'
  rear-behavior:
    desc: JS
    cmds:
      -  pnpm rollup -c {{.PROJECT_DIR}}/rollup.config.mjs
    env:
      NODE_ENV: prod
  put-vendor:
    desc: Copy 3rd party scripts/stylesheets/etc
    cmds:
      - cp {{.COMMON_DIR}}/vendor/meyerweb/reset.min.css {{.OCTOCAT_HOST_DIR}}/{{.VENDOR_CSS_RESET_NAME}}
      - cp {{.COMMON_DIR}}/vendor/html2canvas/html2canvas.min.js {{.OCTOCAT_HOST_DIR}}/{{.VENDOR_HTML2CANVAS_NAME}}
      - cp {{.COMMON_DIR}}/vendor/chancejs/chance.min.js {{.OCTOCAT_HOST_DIR}}/{{.VENDOR_CHANCEJS_NAME}}
      - echo "MeyerWeb-CSSReset, HTML2Canvas and ChanceJS placed with pages host files"
  put-meta:
    desc: Place fils needed for pwa
    cmds:
      - cp {{.COMMON_DIR}}/favicons/sqwiggle.ico {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_ICO_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle-alt.ico {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_ICO_ALT_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_16.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_16_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_16-alt.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_16_ALT_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_32.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_32_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_32-alt.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_32_ALT_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_180.png {{.OCTOCAT_HOST_DIR}}/{{.APPLE_TOUCH_ICON_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_192.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_ANDROID_CHROME_192_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_512.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_ANDROID_CHROME_512_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_70.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_MSTILE_s70_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_144.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_MSTILE_s144_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_150.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_MSTILE_s150_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_310.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_MSTILE_s310_NAME}}
      - cp {{.COMMON_DIR}}/favicons/sqwiggle_310x150.png {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_MSTILE_w310_NAME}}
      - cp {{.CONTENT_DIR}}/webmanifest.source.json {{.OCTOCAT_HOST_DIR}}/{{.WEBMANIFEST_NAME}}
      - echo "Favicon and Offline files placed with pages host files"
  set-meta:
    desc: Update pwa files
    cmds:
      - jq '.id|=env.OCTOCAT_HOST | .start_url|=env.OCTOCAT_HOST | .icons[0].src|=env.FAVICON_ANDROID_CHROME_192_URL | .icons[1].src|=env.FAVICON_ANDROID_CHROME_512_URL' {{.CONTENT_DIR}}/webmanifest.source.json > {{.OCTOCAT_HOST_DIR}}/site.webmanifest
      - echo {{.META_DATA}} > {{.OCTOCAT_HOST_DIR}}/content_data_options.json
      - pnpm pug {{.CONTENT_DIR}}/browserconfig.source.pug -o {{.OCTOCAT_HOST_DIR}} -O {{.OCTOCAT_HOST_DIR}}/content_data_options.json
      - mv {{.OCTOCAT_HOST_DIR}}/browserconfig.source.html {{.OCTOCAT_HOST_DIR}}/{{.BROWSERCONFIG_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/content_data_options.json
    env:
      FAVICON_ANDROID_CHROME_192_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_ANDROID_CHROME_192_NAME}}'
      FAVICON_ANDROID_CHROME_512_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_ANDROID_CHROME_512_NAME}}'
    vars:
      FAVICON_MSTILE_s70_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_MSTILE_s70_NAME}}'
      FAVICON_MSTILE_s144_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_MSTILE_s144_NAME}}'
      FAVICON_MSTILE_s150_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_MSTILE_s150_NAME}}'
      FAVICON_MSTILE_s310_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_MSTILE_s310_NAME}}'
      FAVICON_MSTILE_w310_URL: '{{.OCTOCAT_HOST}}{{.FAVICON_MSTILE_w310_NAME}}'
      META_DATA: '{\"FAVICON_MSTILE_s70_URL\": \"{{.FAVICON_MSTILE_s70_URL}}\",\"FAVICON_MSTILE_s144_URL\": \"{{.FAVICON_MSTILE_s144_URL}}\",\"FAVICON_MSTILE_s150_URL\": \"{{.FAVICON_MSTILE_s150_URL}}\",\"FAVICON_MSTILE_s310_URL\": \"{{.FAVICON_MSTILE_s310_URL}}\",\"FAVICON_MSTILE_w310_URL\": \"{{.FAVICON_MSTILE_w310_URL}}\"}'
  sweep-content:
    desc: Clear out pages host directory
    cmds:
      - rm -f {{.OCTOCAT_HOST_DIR}}/index.html
      - rm -f {{.OCTOCAT_HOST_DIR}}/content_data_options.json
      - rm -f {{.OCTOCAT_HOST_DIR}}/markl.svg
  sweep-presentation:
    desc: Clear out pages host directory
    cmds:
      - rm -f {{.OCTOCAT_HOST_DIR}}/main.css
  sweep-behavior:
    desc: Clear out pages host directory
    cmds:
      - rm -f {{.OCTOCAT_HOST_DIR}}/main.{js,mjs}
  sweep-vendor:
    desc: Remove generated files
    cmds:
      - rm -f {{.OCTOCAT_HOST_DIR}}/html2canvas.{js,js.map}
      - rm -f {{.OCTOCAT_HOST_DIR}}/chance.{js,min.js,min.js.map}
      - rm -f {{.OCTOCAT_HOST_DIR}}/reset.css
  sweep-meta:
    desc: Remove generated files
    cmds:
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_ICO_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_ICO_ALT_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_16_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_16_ALT_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_32_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_32_ALT_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.APPLE_TOUCH_ICON_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_ANDROID_CHROME_192_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_ANDROID_CHROME_512_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_MSTILE_s70_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_MSTILE_s144_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_MSTILE_s150_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_MSTILE_s310_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.FAVICON_MSTILE_w310_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.BROWSERCONFIG_NAME}}
      - rm -f {{.OCTOCAT_HOST_DIR}}/{{.WEBMANIFEST_NAME}}
